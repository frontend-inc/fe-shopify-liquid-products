<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page_title | default: 'Frontend | Shopify' }}</title>

  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4?plugins=typography,forms"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style type="text/tailwindcss">
    @theme {
      --color-background: hsl(0 0% 100%);
      --color-foreground: hsl(222.2 84% 4.9%);
      --color-card: hsl(0 0% 100%);
      --color-card-foreground: hsl(222.2 84% 4.9%);
      --color-popover: hsl(0 0% 100%);
      --color-popover-foreground: hsl(222.2 84% 4.9%);
      --color-primary: hsl(222.2 47.4% 11.2%);
      --color-primary-foreground: hsl(210 40% 98%);
      --color-secondary: hsl(210 40% 96.1%);
      --color-secondary-foreground: hsl(222.2 47.4% 11.2%);
      --color-muted: hsl(210 40% 96.1%);
      --color-muted-foreground: hsl(215.4 16.3% 46.9%);
      --color-accent: hsl(210 40% 96.1%);
      --color-accent-foreground: hsl(222.2 47.4% 11.2%);
      --color-destructive: hsl(0 84.2% 60.2%);
      --color-destructive-foreground: hsl(210 40% 98%);
      --color-border: hsl(214.3 31.8% 91.4%);
      --color-input: hsl(214.3 31.8% 91.4%);
      --color-ring: hsl(222.2 84% 4.9%);
      --radius-sm: 0.25rem;
      --radius-md: 0.375rem;
      --radius-lg: 0.5rem;
      --radius-xl: 0.75rem;
      --font-heading: "Playfair Display", sans-serif;
      --font-body: "Inter", sans-serif;
    }

    .dark {
      --color-background: hsl(222.2 84% 4.9%);
      --color-foreground: hsl(210 40% 98%);
      --color-card: hsl(222.2 84% 4.9%);
      --color-card-foreground: hsl(210 40% 98%);
      --color-popover: hsl(222.2 84% 4.9%);
      --color-popover-foreground: hsl(210 40% 98%);
      --color-primary: hsl(210 40% 98%);
      --color-primary-foreground: hsl(222.2 47.4% 11.2%);
      --color-secondary: hsl(217.2 32.6% 17.5%);
      --color-secondary-foreground: hsl(210 40% 98%);
      --color-muted: hsl(217.2 32.6% 17.5%);
      --color-muted-foreground: hsl(215 20.2% 65.1%);
      --color-accent: hsl(217.2 32.6% 17.5%);
      --color-accent-foreground: hsl(210 40% 98%);
      --color-destructive: hsl(0 62.8% 30.6%);
      --color-destructive-foreground: hsl(210 40% 98%);
      --color-border: hsl(217.2 32.6% 17.5%);
      --color-input: hsl(217.2 32.6% 17.5%);
      --color-ring: hsl(212.7 26.8% 83.9%);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col m-0 p-0 font-body bg-background text-foreground">
  <header class="sticky top-0 z-50 bg-background border-b border-border">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="text-2xl font-bold font-heading">{{ shop_name | default: 'Store' }}</a>

      <nav class="hidden md:flex items-center gap-6">
        <a href="/collections/all" class="text-sm font-medium text-foreground hover:text-primary transition-colors">Shop</a>
        <a href="/collections" class="text-sm font-medium text-foreground hover:text-primary transition-colors">Collections</a>
        <a href="/pages/about" class="text-sm font-medium text-foreground hover:text-primary transition-colors">About</a>
        <a href="/pages/contact" class="text-sm font-medium text-foreground hover:text-primary transition-colors">Contact</a>
      </nav>

      <div class="flex items-center gap-4">
        <button class="p-2 hover:bg-accent rounded-md transition-colors">
          <i class="ri-search-line text-xl"></i>
        </button>
        {% include 'partials/cart-button' %}
      </div>
    </div>
  </header>

  <main class="flex-1">
    {% block content %}{% endblock %}
  </main>

  <footer class="bg-muted border-t border-border">
    <div class="container mx-auto px-4 py-12">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="font-heading text-lg font-semibold mb-4">{{ shop_name | default: 'Store' }}</h3>
          <p class="text-muted-foreground text-sm">{{ shop_description | default: 'Your trusted online store.' }}</p>
        </div>
        <div>
          <h4 class="font-semibold mb-4">Shop</h4>
          <ul class="space-y-2 text-sm text-muted-foreground">
            <li><a href="/collections/all" class="hover:text-foreground transition-colors">All Products</a></li>
            <li><a href="/collections" class="hover:text-foreground transition-colors">Collections</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold mb-4">Help</h4>
          <ul class="space-y-2 text-sm text-muted-foreground">
            <li><a href="/pages/contact" class="hover:text-foreground transition-colors">Contact</a></li>
            <li><a href="/pages/shipping" class="hover:text-foreground transition-colors">Shipping</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold mb-4">Follow Us</h4>
          <div class="flex gap-4">
            <a href="#" class="text-muted-foreground hover:text-foreground transition-colors">
              <i class="ri-instagram-line text-xl"></i>
            </a>
            <a href="#" class="text-muted-foreground hover:text-foreground transition-colors">
              <i class="ri-twitter-x-line text-xl"></i>
            </a>
            <a href="#" class="text-muted-foreground hover:text-foreground transition-colors">
              <i class="ri-facebook-line text-xl"></i>
            </a>
          </div>
        </div>
      </div>
      <div class="border-t border-border mt-8 pt-8 text-center text-sm text-muted-foreground">
        <p>&copy; {{ 'now' | date: '%Y' }} {{ shop_name | default: 'Store' }}. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    const ShopifyAPI = {
      async getCart() {
        const response = await fetch('/cart.js');
        return response.json();
      },

      async addToCart(variantId, quantity = 1, properties = {}) {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: variantId, quantity, properties })
        });
        return response.json();
      },

      async updateCart(updates) {
        const response = await fetch('/cart/update.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ updates })
        });
        return response.json();
      },

      async changeCartItem(line, quantity) {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ line, quantity })
        });
        return response.json();
      },

      async removeFromCart(line) {
        return this.changeCartItem(line, 0);
      },

      async clearCart() {
        const response = await fetch('/cart/clear.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        return response.json();
      },

      async getProduct(handle) {
        const response = await fetch(`/products/${handle}.js`);
        return response.json();
      },

      async getCollection(handle, page = 1) {
        const response = await fetch(`/collections/${handle}/products.json?page=${page}`);
        return response.json();
      },

      formatMoney(cents, format = '${{amount}}') {
        const amount = (cents / 100).toFixed(2);
        return format.replace('{{amount}}', amount);
      }
    };

    document.addEventListener('alpine:init', () => {
      Alpine.data('productCard', ({ variantId }) => ({
        variantId,
        loading: false,
        added: false,

        async addToCart() {
          this.loading = true;
          try {
            await ShopifyAPI.addToCart(this.variantId, 1);
            this.added = true;
            window.dispatchEvent(new CustomEvent('cart:updated'));
            setTimeout(() => { this.added = false; }, 1500);
          } catch (error) {
            console.error('Error adding to cart:', error);
          } finally {
            this.loading = false;
          }
        }
      }));

      Alpine.data('cartButton', () => ({
        itemCount: 0,
        loading: false,

        async fetchCart() {
          try {
            const cart = await ShopifyAPI.getCart();
            this.itemCount = cart.item_count;
          } catch (error) {
            console.error('Error fetching cart:', error);
          }
        }
      }));

      Alpine.data('imageGallery', ({ images }) => ({
        images,
        selectedIndex: 0,

        selectImage(index) {
          this.selectedIndex = index;
        },

        nextImage() {
          this.selectedIndex = (this.selectedIndex + 1) % this.images.length;
        },

        prevImage() {
          this.selectedIndex = (this.selectedIndex - 1 + this.images.length) % this.images.length;
        }
      }));

      Alpine.data('productDetails', ({ product, initialVariantId }) => ({
        product,
        variants: product.variants,
        selectedVariant: null,
        selectedOptions: {},
        quantity: 1,
        loading: false,
        added: false,
        error: null,
        currentPrice: 0,
        currentComparePrice: 0,

        init() {
          // Initialize selected options from initial variant
          const initialVariant = this.variants.find(v => v.id === initialVariantId) || this.variants[0];
          if (initialVariant) {
            this.selectedVariant = initialVariant;
            this.currentPrice = initialVariant.price;
            this.currentComparePrice = initialVariant.compare_at_price || 0;

            // Parse options from variant title
            if (this.product.options && initialVariant.options) {
              this.product.options.forEach((option, index) => {
                this.selectedOptions[option] = initialVariant.options[index];
              });
            }
          }
        },

        selectOption(optionName, value) {
          this.selectedOptions[optionName] = value;
          this.updateSelectedVariant();
        },

        updateSelectedVariant() {
          // Find variant matching all selected options
          const variant = this.variants.find(v => {
            return this.product.options.every((option, index) => {
              return v.options[index] === this.selectedOptions[option];
            });
          });

          if (variant) {
            this.selectedVariant = variant;
            this.currentPrice = variant.price;
            this.currentComparePrice = variant.compare_at_price || 0;

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('variant', variant.id);
            window.history.replaceState({}, '', url);

            // Update image gallery to show variant image
            if (variant.featured_image) {
              const imageIndex = this.product.images.findIndex(img => img.id === variant.featured_image.id);
              if (imageIndex !== -1) {
                window.dispatchEvent(new CustomEvent('variant:image', { detail: { index: imageIndex } }));
              }
            }
          }
        },

        async addToCart() {
          if (!this.selectedVariant?.available) return;

          this.loading = true;
          this.error = null;

          try {
            await ShopifyAPI.addToCart(this.selectedVariant.id, this.quantity);
            this.added = true;
            window.dispatchEvent(new CustomEvent('cart:updated'));
            setTimeout(() => { this.added = false; }, 2000);
          } catch (error) {
            console.error('Error adding to cart:', error);
            this.error = 'Failed to add to cart. Please try again.';
          } finally {
            this.loading = false;
          }
        },

        async buyNow() {
          if (!this.selectedVariant?.available) return;

          this.loading = true;
          this.error = null;

          try {
            await ShopifyAPI.addToCart(this.selectedVariant.id, this.quantity);
            window.location.href = '/checkout';
          } catch (error) {
            console.error('Error adding to cart:', error);
            this.error = 'Failed to proceed to checkout. Please try again.';
            this.loading = false;
          }
        },

        copyLink() {
          navigator.clipboard.writeText(window.location.href);
        }
      }));
    });
  </script>
</body>
</html>
